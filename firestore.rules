rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isLoggedIn() {
      return request.auth != null;
    }
    
    function isInWhitelist() {
      return isLoggedIn() && exists(/databases/$(database)/documents/allowed_users/$(request.auth.token.email));
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/allowed_users/$(request.auth.token.email)).data.role;
    }
    
    function isAdmin() {
      return isInWhitelist() && (getUserRole().matches('.*admin.*') || getUserRole().matches('.*super-admin.*'));
    }

    // ============================================
    // AUTH & USERS
    // ============================================
    
    match /allowed_users/{email} {
      allow read: if isLoggedIn() && (request.auth.token.email == email || isAdmin());
      allow create: if isAdmin() || (isLoggedIn() && request.auth.token.email == email); // Self-registration allowed if email matches
      allow update: if isLoggedIn() && (request.auth.token.email == email || isAdmin());
      allow delete: if isAdmin();
    }
    
    match /users/{email} {
      allow read: if isLoggedIn();
      allow write: if isLoggedIn() && request.auth.token.email == email;
    }

    // ============================================
    // EXAMS & CONTENT (Practice, E-Test, Vocab)
    // ============================================
    
    // Practice Exams
    match /exams/{examId} {
      allow read: if isLoggedIn();
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || (isLoggedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['attemptCount']));
    }
    
    match /exam_contents/{examId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    // E-Test & Vocab
    match /etest_exams/{examId} {
      allow read: if isInWhitelist();
      allow write: if isAdmin();
    }
    
    match /vocab_sets/{setId} {
      allow read: if isInWhitelist();
      allow write: if isAdmin();
    }

    // ============================================
    // USER ACTIVITY & TRACKING
    // ============================================
    
    match /practice_history/{historyId} {
      allow read: if isLoggedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isLoggedIn() && request.resource.data.userId == request.auth.uid;
    }
    
    match /practice_logs/{logId} {
      allow read: if isAdmin() || (isLoggedIn() && resource.data.userEmail == request.auth.token.email);
      allow create: if isLoggedIn();
      allow update: if isLoggedIn() && resource.data.userEmail == request.auth.token.email;
    }

    match /user_activity_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isLoggedIn() && request.resource.data.userEmail == request.auth.token.email;
    }
    
    match /whitelist_logs/{logId} {
      allow read, write: if isAdmin();
    }

    // ============================================
    // SYSTEM & FEEDBACK
    // ============================================
    
    match /feedbacks/{examId}/comments/{commentId} {
      allow read: if isLoggedIn();
      allow create: if isLoggedIn();
      allow update, delete: if isLoggedIn() && (request.auth.uid == resource.data.userId || isAdmin());
    }
    
    match /notifications/{notifId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    // ============================================
    // CHAT SYSTEM
    // ============================================

    match /chats/{ownerEmail}/convos/{partnerKey} {
      // Allow read if user is the owner OR is one of the participants
      allow read: if isLoggedIn() && (
        request.auth.token.email == ownerEmail || 
        request.auth.token.email in resource.data.participants
      );
      
      // Allow write (create/update) if user is the owner OR is in the participants list
      allow write: if isLoggedIn() && (
        request.auth.token.email == ownerEmail || 
        request.auth.token.email in request.resource.data.participants ||
        (resource != null && request.auth.token.email in resource.data.participants)
      );
    }

    match /users/{email} {
      allow read: if isLoggedIn();
      allow write: if isLoggedIn() && request.auth.token.email == email;
    }
    
    match /allowed_users/{email} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }
  }
}
